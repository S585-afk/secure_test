name: API Security with Authenticated ZAP - FraudRules

on:
  workflow_dispatch:   # Manual trigger button
  push:
    branches: [ main ]

jobs:
  security-scan:
    runs-on: ubuntu-latest

    steps:

    # 1️⃣ Checkout Repository
    - name: Checkout Repository
      uses: actions/checkout@v4

    # 2️⃣ Call FraudRules API directly (Sanity Check)
    - name: Call FraudRules API using curl
      run: |
        curl -i --location 'https://api.trackier.com/v2/fraudrules' \
        --header "X-Api-Key: ${{ secrets.TRACKIER_API_KEY }}" \
        --header "Accept: application/json"

    # 3️⃣ Run Authenticated ZAP Full Scan
    - name: Run ZAP Full Scan with API Key
      uses: zaproxy/action-full-scan@v0.8.0
      with:
        target: 'https://api.trackier.com'
        fail_action: false
        cmd_options: >
          -z "
          -config replacer.full_list(0).description=api-key
          -config replacer.full_list(0).enabled=true
          -config replacer.full_list(0).matchtype=REQ_HEADER
          -config replacer.full_list(0).matchstr=X-Api-Key
          -config replacer.full_list(0).replacement=${{ secrets.TRACKIER_API_KEY }}
          "

    # 4️⃣ Upload ZAP HTML Report
    - name: Upload ZAP Report
  if: always()
  uses: actions/upload-artifact@v4
  with:
    name: zap-report
    path: report_html.html
