name: API Security with Authenticated ZAP

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  security-scan:
    runs-on: ubuntu-latest

    steps:

    # 1️⃣ Call API directly (sanity check)
    - name: Call API using curl
      run: |
        curl -i --location 'http://restapi-qa.trackier.io/v2/campaigns/25946' \
        --header "x-api-key: ${{ secrets.TRACKIER_API_KEY }}"

    # 2️⃣ Run Authenticated ZAP Scan
    - name: Run ZAP Full Scan with API Key
      uses: zaproxy/action-full-scan@v0.7.0
      with:
        target: 'http://restapi-qa.trackier.io'
        fail_action: false
        cmd_options: >
          -z "
          -config replacer.full_list(0).description=api-key
          -config replacer.full_list(0).enabled=true
          -config replacer.full_list(0).matchtype=REQ_HEADER
          -config replacer.full_list(0).matchstr=x-api-key
          -config replacer.full_list(0).replacement=${{ secrets.TRACKIER_API_KEY }}
          "

    # 3️⃣ Upload ZAP Report
    - name: Upload ZAP Report
      uses: actions/upload-artifact@v3
      with:
        name: zap-report
        path: report_html.html